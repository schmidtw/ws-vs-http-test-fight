package main

import (
	"fmt"
	"github.com/gorilla/websocket"
	"sync"
	"time"
)

func main() {

	var wg sync.WaitGroup
	var wg1 sync.WaitGroup

	out := make(chan []byte, 1000000)

	wg.Add(1000)
	for i := 0; i < 1000; i++ {
		go func() {
			time.Sleep(time.Second)
			for j := 0; j < 1000; j++ {
				out <- []byte("Hello, world.----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------")
			}
			wg.Done()
		}()
	}

	wg1.Add(1)
	go func() {
		start := time.Now()
		c, _, err := websocket.DefaultDialer.Dial("ws://localhost:8080/", nil)

		fmt.Printf("err: %v\n", err)
		for range out {
			c.WriteMessage(websocket.BinaryMessage, <-out)
		}
		delta := time.Since(start)

		fmt.Printf("Delta: %s\n", delta.String())
		wg1.Done()
	}()
	wg.Wait()
	close(out)
	wg1.Wait()
}
